/** ******************************************************************************
 *  (c) 2020 Zondax GmbH
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 ******************************************************************************* */

import jest, {expect} from "jest";
import Zemu from "@zondax/zemu";
import CryptoApp from "@zondax/ledger-crypto";
import secp256k1 from "secp256k1/elliptic";
import blake3 from "blake3-js"

const Resolve = require("path").resolve;
const APP_PATH = Resolve("../app/bin/app.elf");

const APP_SEED = "equip will roof matter pink blind book anxiety banner elbow sun young"
const simOptions = {
    logging: true,
    start_delay: 3000,
    custom: `-s "${APP_SEED}"`
//    , X11: true
};

jest.setTimeout(60000)

function compareSnapshots(snapshotPrefixTmp, snapshotPrefixGolden, snapshotCount) {
    for (let i = 0; i < snapshotCount; i++) {
        const img1 = Zemu.LoadPng2RGB(`${snapshotPrefixTmp}${i}.png`);
        const img2 = Zemu.LoadPng2RGB(`${snapshotPrefixGolden}${i}.png`);
        expect(img1).toEqual(img2);
    }
}

describe('Basic checks', function () {
    test('can start and stop container', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
        } finally {
            await sim.close();
        }
    });

    test('get app version', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());
            const resp = await app.getVersion();

            console.log(resp);

            expect(resp.returnCode).toEqual(0x9000);
            expect(resp.errorMessage).toEqual("No errors");
            expect(resp).toHaveProperty("testMode");
            expect(resp).toHaveProperty("major");
            expect(resp).toHaveProperty("minor");
            expect(resp).toHaveProperty("patch");
        } finally {
            await sim.close();
        }
    });

    test('get address - transfer', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            const response = await app.getAddressAndPubKey("m/44'/394'/0'/0/0");
            console.log(response)
            expect(response.returnCode).toEqual(0x9000);

            const expected_publicKey = "048ef50054db1b8c5ff9b02640a25463a37ca7d4249da43b4e6f4ea8f7af70daec5e276294642dec9dc28079397d6962cc32d3909e92995167768fbde7250424d9";
            const expected_address = "cro1n97t35jymgksmh73mh0zj3qx539k3hg4pfhmncake4ssm3z7rreqzkza53";

            expect(response.publicKey.toString('hex')).toEqual(expected_publicKey);
            expect(response.address).toEqual(expected_address);

        } finally {
            await sim.close();
        }
    });

    test('get address - staking', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            const response = await app.getAddressAndPubKey("m/44'/394'/1'/0/0");
            console.log(response)
            expect(response.returnCode).toEqual(0x9000);

            const expected_publicKey = "04eda422888bff3b3fa957ab9a509b6ae70c1249c9b9b35f1832aeb2e9a4f94b86076054d2641464e55f85e0c6d27d7dcebd60386f6178dec5e77a2a03330952aa";
            const expected_address = "f3c7d0d3439c174b9ce8178c2d2ea95dc1f45c28";

            expect(response.publicKey.toString('hex')).toEqual(expected_publicKey);
            expect(response.address).toEqual(expected_address);

        } finally {
            await sim.close();
        }
    });

    test('show address - transfer', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            const addrRequest = app.showAddressAndPubKey("m/44'/394'/0'/0/1");
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);

            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickBoth();

            const response = await addrRequest;
            console.log(response)
            expect(response.returnCode).toEqual(0x9000);

            const expected_publicKey = "04db0c6d56193c5b12fa2588d4254db1eb90d502852f3bd71beb8cd7d5eda3747cae746dfc75bfcbc48c1664fc494828daf6683e9fa331875ac894d8a2a296aa7e";
            const expected_address = "cro1d0dxrfy0jf4mr0tnrkdaaay3v706z5hfdhw42ac8f20jd9w7u9lsrqcfjz";

            expect(response.publicKey.toString('hex')).toEqual(expected_publicKey);
            expect(response.address).toEqual(expected_address);
        } finally {
            await sim.close();
        }
    });

    test('show address - transfer - expert', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            await sim.clickRight();
            await sim.clickBoth();

            const addrRequest = app.showAddressAndPubKey("m/44'/394'/0'/0/1");
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);

            await sim.clickRight();
            await sim.clickRight();
            await sim.clickBoth();
            await sim.clickBoth();

            const response = await addrRequest;
            console.log(response)
            expect(response.returnCode).toEqual(0x9000);

            const expected_publicKey = "04db0c6d56193c5b12fa2588d4254db1eb90d502852f3bd71beb8cd7d5eda3747cae746dfc75bfcbc48c1664fc494828daf6683e9fa331875ac894d8a2a296aa7e";
            const expected_address = "cro1d0dxrfy0jf4mr0tnrkdaaay3v706z5hfdhw42ac8f20jd9w7u9lsrqcfjz";

            expect(response.publicKey.toString('hex')).toEqual(expected_publicKey);
            expect(response.address).toEqual(expected_address);
        } finally {
            await sim.close();
        }
    });

    test('show address - transfer - testnet', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            const addrRequest = app.showAddressAndPubKey("m/44'/1'/0'/0/1");
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);

            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickBoth();

            const response = await addrRequest;
            console.log(response)
            expect(response.returnCode).toEqual(0x9000);

            const expected_publicKey = "0457605444d19911c74882a01ccd708973b0b7672c89502f93c549675d1e9c0ee0a6814f3bf0f04a012fa5037b1e7f7e54e72a99a7c34adfc0fabee1948219b86d";
            const expected_address = "tcro1fz2t9gwnut4lsnm3tfrdch4fdulwzp7tkc5um8jxpqfswk3f0lesvaztj5";

            expect(response.publicKey.toString('hex')).toEqual(expected_publicKey);
            expect(response.address).toEqual(expected_address);
        } finally {
            await sim.close();
        }
    });

    test('show address - staking', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            const addrRequest = app.showAddressAndPubKey("m/44'/394'/1'/0/1");
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);

            await sim.clickRight();
            await sim.clickRight();
            await sim.clickBoth();

            const response = await addrRequest;
            console.log(response)
            expect(response.returnCode).toEqual(0x9000);

            const expected_publicKey = "042eec2a1e00ece871fb2697bd7cb44732ef9664ac543c9b57916a691bf63fd22ae5f534194eadeee84d6472e116b41cf9a674e92e772d574b6f3b032c9becfa76";
            const expected_address = "c4bb0afc4c1639efbc1ea06aee8847e79b8fa00b";

            expect(response.publicKey.toString('hex')).toEqual(expected_publicKey);
            expect(response.address).toEqual(expected_address);
        } finally {
            await sim.close();
        }
    });

    test('show address - staking - testnet', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            const addrRequest = app.showAddressAndPubKey("m/44'/1'/1'/0/1");
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);

            await sim.clickRight();
            await sim.clickRight();
            await sim.clickBoth();

            const response = await addrRequest;
            console.log(response)
            expect(response.returnCode).toEqual(0x9000);

            const expected_publicKey = "042bd4f7bbeeea93f843131c7e38d73b0a79eb1a6e9a23d00e8e0779df7c37305b5d8bc52930ebacf477f57d8340c3fadf8ffbc5027caa2b5ac2d5b0f833a69a05";
            const expected_address = "a3b92de76e57805d29aaefe171f6230e22b1ccb9";

            expect(response.publicKey.toString('hex')).toEqual(expected_publicKey);
            expect(response.address).toEqual(expected_address);
        } finally {
            await sim.close();
        }
    });

    test('sign', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            const path = "m/44'/394'/1'/0/1";
            const blobStr = "00020000000000000000040009cbc2ce0dd314d5a7c658c866a4faf2d8510c6912313859eee908322bd7daf5e803000000000000010000000000000000000004036b3e5b7744134ac0556ace88b098a057014afb82701b1b1ba49ea04b09fea29b000100000000000000"
            const blob = Buffer.from(blobStr, "hex")

            const addrResponse = await app.getAddressAndPubKey(path);
            console.log(addrResponse)

            const pk = Uint8Array.from(addrResponse.publicKey)
            const blobToHash = blob.slice(2, blob.length)
            const msgHash = Uint8Array.from(blake3
                .newRegular()
                .update(blobToHash)
                .finalize(32, "bytes"));
            console.log("Blob To Hash: ", Buffer.from(blobToHash).toString("hex"))
            console.log("TX ID       :  ", Buffer.from(msgHash).toString("hex"))

            // Do not await.. we need to click asynchronously
            const signatureRequest = app.sign(path, blob);
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);

            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickBoth();

            let signatureResponse = await signatureRequest;
            console.log(signatureResponse)
            expect(signatureResponse.returnCode).toEqual(0x9000);

            // Now verify the signature
            const signature = secp256k1.signatureImport(Uint8Array.from(signatureResponse.signatureDER));
            const signatureOk = secp256k1.ecdsaVerify(signature, msgHash, pk);
            expect(signatureOk).toEqual(true);
        } finally {
            await sim.close();
        }
    });

    test('sign twice', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            // Enable expert mode
            await sim.clickRight();
            await sim.clickBoth();

            const path = "m/44'/394'/1'/0/1";
            const addrResponse = await app.getAddressAndPubKey(path);
            const pk = Uint8Array.from(addrResponse.publicKey)
            console.log(addrResponse)

            // Sign once
            const blobStr1 = "010000410afb0ccf51aefd111bceafb6c298acd4decaf60000000000000000e803000000000000002a0100000000000000"
            const blob1 = Buffer.from(blobStr1, "hex")

            let blobToHash = blob1.slice(2, blob1.length)
            let msgHash = Uint8Array.from(blake3.newRegular().update(blobToHash).finalize(32, "bytes"));

            // Do not await.. we need to click asynchronously
            let signatureRequest = app.sign(path, blob1);
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);
            await sim.clickBoth();
            await sim.clickBoth();
            let signatureResponse = await signatureRequest;

            console.log(signatureResponse)
            expect(signatureResponse.returnCode).toEqual(0x9000);
            // Now verify the signature
            let signature = secp256k1.signatureImport(Uint8Array.from(signatureResponse.signatureDER));
            let signatureOk = secp256k1.ecdsaVerify(signature, msgHash, pk);
            expect(signatureOk).toEqual(true);

            // Sign a second time
            const blobStr2 = "00020000000000000000040009cbc2ce0dd314d5a7c658c866a4faf2d8510c6912313859eee908322bd7daf5e803000000000000010000000000000000000004036b3e5b7744134ac0556ace88b098a057014afb82701b1b1ba49ea04b09fea29b000100000000000000"
            const blob2 = Buffer.from(blobStr2, "hex")

            blobToHash = blob2.slice(2, blob2.length)
            msgHash = Uint8Array.from(blake3.newRegular().update(blobToHash).finalize(32, "bytes"));

            // Do not await.. we need to click asynchronously
            signatureRequest = app.sign(path, blob2);
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);
            await sim.clickBoth();
            await sim.clickBoth();
            signatureResponse = await signatureRequest;

            console.log(signatureResponse)
            expect(signatureResponse.returnCode).toEqual(0x9000);
            // Now verify the signature
            signature = secp256k1.signatureImport(Uint8Array.from(signatureResponse.signatureDER));
            signatureOk = secp256k1.ecdsaVerify(signature, msgHash, pk);
            expect(signatureOk).toEqual(true);

        } finally {
            await sim.close();
        }
    });

    test('sign massive', async function () {
        const sim = new Zemu(APP_PATH);
        try {
            await sim.start(simOptions);
            const app = new CryptoApp(sim.getTransport());

            const path = "m/44'/394'/1'/0/1";
            const blobStr = "01020100000000000000001d19cf91f6e0dcef9a91fff8d786e790ca18ffac002a0100000000000000001c6578616d706c6501507365637572697479406578616d706c652e636f6d00d75a980182b10ab7d54bfed3c964073a0ee172f3daa62325af021a68f707511a7e0201000000020041044b9b2f66f0481b2ac452df48f20af3add15a818c7b5ad3a8f5ace3806861823ef27d4907d36c5a0ca206e3e7cb4f672d3e8046ba2963325c44059553093d7a7501003fe830823fe430823f89a00302010202012a300a06082a8648ce3d040302302a31133011060355040a0c0a43727970746f2e636f6d3113301106035504030c0a43727970746f2e636f6d3022180f31393730303130313030303030305a180f32303230303832343130343734385a302a31133011060355040a0c0a43727970746f2e636f6d3113301106035504030c0a43727970746f2e636f6d3059301306072a8648ce3d020106082a8648ce3d030107034200044b9b2f66f0481b2ac452df48f20af3add15a818c7b5ad3a8f5ace3806861823ef27d4907d36c5a0ca206e3e7cb4f672d3e8046ba2963325c44059553093d7a75a3823e9a30823e96301e0603551d1104173015811373656375726974794063727970746f2e636f6d30823e7206096086480186f842010d04823e637b22626f6479223a5b3132332c33342c3130352c3130302c33342c35382c33342c35312c34392c35362c35312c35302c35312c35342c35342c35372c34392c35372c35342c35342c35322c34392c35372c35372c35302c35322c35302c35312c34382c35312c35362c35312c35352c35312c35372c35342c35332c35332c35362c35342c35312c35342c35352c35342c35332c34382c33342c34342c33342c3131362c3130352c3130392c3130312c3131352c3131362c39372c3130392c3131322c33342c35382c33342c35302c34382c35302c34382c34352c34382c35332c34352c35302c35342c38342c34392c34382c35382c35322c35352c35382c35332c34382c34362c35352c35312c35322c35332c35352c35342c33342c34342c33342c3131382c3130312c3131342c3131352c3130352c3131312c3131302c33342c35382c35322c34342c33342c39372c3130302c3131382c3130352c3131352c3131312c3131342c3132312c38352c38322c37362c33342c35382c33342c3130342c3131362c3131362c3131322c3131352c35382c34372c34372c3131352c3130312c39392c3131372c3131342c3130352c3131362c3132312c34352c39392c3130312c3131302c3131362c3130312c3131342c34362c3130352c3131302c3131362c3130312c3130382c34362c39392c3131312c3130392c33342c34342c33342c39372c3130302c3131382c3130352c3131352c3131312c3131342c3132312c37332c36382c3131352c33342c35382c39312c33342c37332c37382c38342c36392c37362c34352c38332c36352c34352c34382c34382c35312c35312c35322c33342c39332c34342c33342c3130352c3131352c3131382c36392c3131302c39392c3130382c39372c3131382c3130312c38312c3131372c3131312c3131362c3130312c38332c3131362c39372c3131362c3131372c3131352c33342c35382c33342c38332c38372c39352c37322c36352c38322c36382c36392c37382c37332c37382c37312c39352c37382c36392c36392c36382c36392c36382c33342c34342c33342c3130352c3131352c3131382c36392c3131302c39392c3130382c39372c3131382c3130312c38312c3131372c3131312c3131362c3130312c36362c3131312c3130302c3132312c33342c35382c33342c36352c3130332c36352c36352c36352c37372c38352c37362c36352c36352c36352c37362c36352c36352c3131312c36352c36352c36352c36352c36352c36352c37342c35312c39382c3130342c3130332c37392c37392c36352c38352c3131332c36392c36382c3131372c3131362c39302c37382c3130352c34372c37392c37312c3130362c38352c34332c3130332c38312c3131302c38322c38352c3130392c3132302c3130332c37322c37322c35322c37352c37342c38342c39392c38302c37382c38382c3130302c34372c36382c3131392c35362c36372c36362c3130322c34332c36352c36362c3131392c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36362c3131392c36352c36352c36352c36352c36352c36352c36352c36352c36352c3130322c36352c36352c36352c36352c36352c36352c36352c36352c36352c37342c34392c37322c37302c38322c38332c35332c3131392c38332c34332c38302c37322c34392c3130342c36382c37382c3132302c3130352c3131312c3130392c37372c39302c37342c3130332c3131302c35362c3132322c3131302c3130362c37332c3130332c38302c3131382c38322c38372c39382c39392c35302c37352c37362c35372c3132302c3131392c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36372c39372c34372c35362c34332c3131372c38322c35352c3130342c37332c35352c36372c3132312c3131382c37322c36392c3130392c34382c3131352c3131312c37382c38342c37322c3130342c3132322c36392c37342c3130322c3130372c34392c3130332c3131342c37382c3131312c36362c3131372c38352c3131332c38312c35372c3130312c37382c37312c3130332c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36352c36362c37362c3130392c3132312c35372c3130392c35362c36392c3130332c39382c37352c3131352c38322c38332c35312c34382c3130362c3132312c36372c3131382c37392c3131362c34382c38362c3131332c36362c3130362c37322c3131362c39372c34382c35342c3130362c34392c3131342c37392c37392c36352c39372c37312c37312c36372c38302c3131382c37342c35372c38332c38312c3130322c38342c39382c37302c3131312c37372c3131312c3130332c39382c3130362c35332c35362c3131362c38302c39302c3132312c34382c34332c3130332c36392c39372c35342c37352c38372c37372c3132312c38382c36392c38312c37302c3130382c38362c37372c37342c38302c38382c3131322c34392c33342c3132355d2c227369676e6174757265223a5b3136302c34312c3139312c32352c3139332c3232382c32382c3133362c3230392c36372c3233312c3135382c3136382c3233372c392c3138352c34302c35382c3133372c34392c3130352c3137322c352c3230342c3233342c38312c38332c3133302c3135332c3132382c3134352c3235342c3136332c35372c3135352c312c3232342c31322c3131342c3231392c35322c3230362c39362c3234312c3137382c31342c38332c33302c3134302c3232382c3231372c38312c32362c3137332c3232332c322c3138332c3130322c3130332c3233312c3232312c3134362c35382c3136352c3233382c3132352c36352c3137382c36352c3231342c3230372c34332c38352c3133332c3231352c32362c3131362c3137352c3134322c3234302c37342c3139372c3132302c3134332c3132332c32322c32382c342c3130362c36362c37362c3233322c3230372c3136382c39392c352c3231342c3135322c3131302c3134322c38362c37332c32342c39302c3233362c3133322c3232342c38392c382c3233332c3137382c33392c33382c3138372c3232362c3135332c33302c34342c3134312c35352c31352c3137392c3230352c3136352c32302c32362c3231302c35322c38352c3231352c36372c3134312c34332c3137302c38372c3132332c37362c3132322c31382c35312c3131372c3232392c36342c3130342c33362c39372c3131352c3130332c3136342c3137322c38372c38372c3137382c3132322c3137312c3133332c31322c35382c3131342c3134362c35362c3231382c3234372c3132362c3139362c36392c3231312c3134322c3135342c3138372c3139332c31382c3132342c3136332c3233342c3137382c3234342c36382c34362c32382c31302c3134332c37362c3139342c32352c3230392c38392c3231302c3233382c3136342c3138302c302c3131352c3131392c3133362c3234322c3234392c3232332c3130332c35372c32312c3138322c3133322c36312c38342c35302c3231372c38312c38362c3230302c31332c3134352c302c3132382c3132382c36362c3231372c3231332c3130302c3230392c3137312c322c3134312c3232382c3232362c3135392c3134362c3230342c3132382c3133372c3131312c39312c3232332c3139392c3231312c3132352c33362c32392c3130342c3235352c3231362c3137302c3133312c3131352c3230342c3135322c3130352c3134372c3131302c33372c3230312c3232372c3230352c372c3136342c36315d2c227369676e696e675f63657274223a5b34352c34352c34352c34352c34352c36362c36392c37312c37332c37382c33372c35302c34382c36372c36392c38322c38342c37332c37302c37332c36372c36352c38342c36392c34352c34352c34352c34352c34352c33372c34382c36352c37372c37332c37332c36392c3131312c38342c36372c36372c36352c3131392c3130392c3130332c36352c3131392c37332c36362c36352c3130332c37332c37342c36352c37382c36392c37322c3130302c3130382c34382c3132312c3131312c35352c36372c38372c37372c36352c34382c37312c36372c38332c3131332c37312c38332c37332c39382c35312c36382c38312c36392c36362c36372c3131392c38352c36352c37372c37322c35322c3132302c36372c3132322c36352c37342c36362c3130332c37382c38362c33372c34382c36352c36362c36352c38392c38342c36352c3130382c38362c38342c37372c38312c3131352c3131392c36372c38312c38392c36382c38362c38312c38312c37332c36382c36352c37342c36382c38312c38342c36392c38352c37372c36362c37332c37312c36352c34392c38352c36392c36362c3131392c3131392c37362c38352c35302c37302c3131372c3130302c37312c36392c3130332c38312c35302c3132302c3130342c39392c3130392c36392c3132302c37312c3130362c36352c38392c36362c3130332c37382c38362c33372c34382c36352c36362c36352c3131312c37372c36392c38352c3130382c3131372c3130302c37312c38362c3131352c37332c36392c37382c3131382c39392c3131302c36362c3131382c39392c3130392c37302c34382c39372c38372c35372c3131372c37372c38342c36352c3131392c37362c3130332c38392c36382c38362c38312c38312c36382c36382c36372c3130302c37342c39382c3131302c38322c3130382c39382c36372c36362c38342c38322c34392c3130332c3130332c38312c38382c38322c34382c39302c38382c37382c34382c33372c34382c36352c38392c38382c38322c3131322c39382c35302c35322c3130332c38352c3130392c38362c3131392c39382c35312c37342c34382c37332c37302c37382c3131322c39302c35302c35332c3131322c39382c3130392c39392c3130332c38312c34382c36392c3131392c37322c3130342c39392c37382c37372c38342c38392c3132302c37372c38342c37332c3132312c37372c36382c3130372c3132322c37382c3130362c38352c35322c38372c3130342c39392c37382c37372c3130362c38392c3132302c37372c38342c37332c3131392c33372c34382c36352c37372c36382c3130372c3132322c37382c3130362c38352c35322c38372c3130362c36362c35352c37372c38312c3131352c3131392c36372c38312c38392c36382c38362c38312c38312c37312c36392c3131392c37342c38362c38352c3132322c36392c37362c37372c36352c3130372c37312c36352c34392c38352c36392c36372c36352c3131392c36372c38312c34382c36392c3132302c37302c36382c36352c38332c36362c3130332c37382c38362c36362c36352c39392c37372c36372c34392c37382c3130342c33372c34382c36352c39382c3131302c38322c3130342c37332c36392c37382c3131352c38392c38382c37342c3130342c37372c38322c3131312c3131392c37312c36352c38392c36382c38362c38312c38312c37352c36382c36362c37302c37342c39382c3131302c38322c3130382c39382c36372c36362c36382c39382c35312c37342c3131392c39382c35312c37342c3130342c3130302c37312c3130382c3131382c39382c3130362c36392c3131362c37372c36372c3131352c37312c36352c34392c38352c36392c36352c3131392c3131392c3130372c33372c34382c36352c38332c38372c35332c34382c39302c38372c3131392c3130332c38352c34382c3130302c38392c37332c36392c37302c34382c3130302c37312c38362c3132322c3130302c37312c37302c34382c39372c38372c35372c3131372c37332c37302c37342c3130382c39392c37312c35372c3132312c3130302c36372c36362c38342c39372c38372c3130302c3131372c39372c38372c35332c3131302c37372c37332c37332c36362c37332c3130362c36352c37382c36362c3130332c3130372c3131332c3130342c3130372c3130352c37312c33372c34382c36352c35372c3131392c34382c36362c36352c38312c36392c37302c36352c36352c37392c36372c36352c38312c35362c36352c37372c37332c37332c36362c36372c3130332c37352c36372c36352c38312c36392c36352c3131332c38382c3131312c3131362c35322c37392c39302c3131372c3131322c3130342c38322c35362c3131302c3131372c3130302c37302c3131342c36352c37302c3130352c39372c37312c3132302c3132302c3130372c3130332c3130392c39372c34372c36392c3131352c34372c36362c36352c33372c35302c36362c3131362c33372c34382c36352c39382c3130312c36372c38342c38352c38322c34392c34382c35342c36352c37362c34392c36392c37382c39392c38372c36352c35322c37302c38382c35312c37352c33372c35302c36362c36392c35372c36362c36362c37362c34382c34372c35352c38382c35332c3131342c3130362c35332c3131302c37332c3130332c38382c34372c38322c34372c34392c3131372c39382c3130342c3130372c37352c38372c3131392c35372c3130332c3130322c3131332c38302c37312c35312c37352c3130312c36352c3131362c37332c3130302c33372c34382c36352c39392c3131382c34372c3131372c38342c37392c34392c3132312c38382c3131382c35332c34382c3131382c3131332c39372c38302c3131382c36392c34392c36372c38322c36372c3130342c3131382c3132322c3130302c38332c34372c39302c36392c36362c3131332c38312c35332c3131312c38362c3131382c37362c38342c38302c39302c35312c38362c36392c3130352c39392c38312c3130362c3130382c3132312c3131362c37352c3130332c37382c35372c39392c37362c3131302c3132302c39382c3131392c3131362c3131372c3131382c33372c34382c36352c37362c38352c37352c35352c3130312c3132312c38322c38302c3130322c37342c38372c34372c3130372c3131352c3130302c3130302c37392c3132322c38302c35362c38362c36362c36362c3131302c3130352c3131312c3130382c38392c3131302c38322c36372c36382c35302c3130362c3131342c37372c38322c39302c35362c3131302c36362c37372c35302c39302c38372c38392c3131392c3131302c38382c3131302c3131392c38392c3130312c37392c36352c37322c38362c33372c35302c36362c38372c35372c3131362c37392c3130342c36352c33372c34382c36352c37332c3130392c3131392c38322c3131392c37352c37302c34372c35372c35332c3132312c36352c3131352c38362c3131392c3130302c35302c34392c3131342c3132312c37322c37372c37342c36362c39392c37312c37322c35352c34382c3131332c37362c39372c3130332c39302c35352c38342c3131362c3132312c3131362c33372c35302c36362c33372c35302c36362c3131332c37392c34372c35342c33372c35302c36362c37352c36352c38382c37342c3131372c37352c3131392c39302c3131332c3130362c38322c3130382c36392c3131362c38332c36392c3132322c35362c33372c34382c36352c3130332c39302c38312c3130312c37302c3130322c38362c38392c3130332c39392c3131392c38332c3130322c3131312c35372c35342c3131312c38332c37372c36352c3132322c38362c3131342c35352c38362c34382c37362c35342c37322c38332c36382c37362c38322c3131302c3131322c39382c35342c3132302c3132302c3130392c39382c38302c3130302c3131332c37382c3131312c3130382c35322c3131362c38312c37332c36382c36352c38312c36352c36362c3131312c35322c37312c3130372c37372c37332c37312c3130342c33372c34382c36352c37372c36362c35362c37312c36352c34392c38352c3130302c37332c3131392c38312c38392c37372c36362c39372c36352c37302c37322c3130342c36382c3130312c35312c39372c3130392c3130322c3131342c3132322c38312c3131342c35312c35332c36372c37382c33372c35302c36362c3131352c34392c3130322c36382c3131372c37322c36352c38362c36392c35362c37372c36352c35322c37312c36352c34392c38352c3130302c36382c3131392c36392c36362c34372c3131392c38312c36392c36352c3131392c37332c37312c33372c34382c36352c3131392c36382c36352c37372c36362c3130332c37382c38362c37322c38322c37372c36362c36352c3130322c35362c36392c36352c3130362c36352c36352c37372c37312c36352c37312c36352c34392c38352c3130302c37322c3131392c38322c39302c37372c37302c39392c3131392c38362c39372c36362c38342c3131312c37302c37312c37312c38342c35302c3130342c34382c3130302c37322c36352c35342c37362c3132312c35372c34382c39392c3131302c38362c3132322c3130302c37312c38362c3130372c33372c34382c36352c39392c35302c38362c3132312c3130302c3130392c3130382c3130362c39302c38382c37372c3131372c39372c38372c35332c34382c39302c38372c3131392c3131372c38392c35302c35372c3131362c37362c35302c37382c3131382c39382c3131302c38322c3130382c39382c3131302c38312c3131382c38312c34392c37342c37372c37362c34392c37382c37322c38372c36372c35372c36362c3130302c37322c38322c3130382c39392c35312c38322c3130342c3130302c37312c3130382c3131382c39382c3130382c37342c3130382c33372c34382c36352c39392c37312c35372c3132312c3130302c37302c37382c3131322c39302c35302c35332c3131322c39382c3130392c3130302c36382c38312c38332c35332c3130362c39392c3130392c3131392c3131392c36382c38312c38392c37342c37352c3131312c39302c37332c3130342c3131382c39392c37382c36352c38312c36392c37362c36362c38312c36352c36382c3130332c3130332c37312c36362c36352c37312c39392c37332c3131362c3130342c3131362c39392c37352c35372c37332c38362c38322c3132322c35322c3131342c33372c34382c36352c38322c3131332c33372c35302c36362c39302c37352c36392c33372c35302c36362c35352c3130372c35332c34382c34372c37392c3132302c38352c3131352c3130392c38372c35362c39372c39372c3131382c37392c3132322c37352c39382c34382c3130352c36372c3132302c34382c35352c38392c38312c35372c3131342c3132322c3130352c35332c3131302c38352c35352c35312c3131362c37372c36392c35302c3132312c37312c38322c37362c3132322c3130342c38332c38362c3130352c37302c3131352c34372c37362c3131322c37302c39372c35372c33372c34382c36352c3130382c3131322c38312c37362c35342c37342c37362c34392c39372c38312c3131392c3130392c36382c38322c35352c35322c38342c3132302c38392c37312c36362c36352c37332c3130352c35332c3130322c35322c37332c35332c38342c37342c3131312c36372c36372c36392c3131332c38322c37322c3132322c35372c34392c3130372c3131322c37312c35342c38352c3131382c3132312c3131302c35302c3131362c37362c3130392c3131302c37332c3130302c37342c39382c38302c36392c35322c3131382c38392c3131382c33372c34382c36352c38372c37362c3131342c3131362c38382c38382c3130322c37302c36362c38332c38332c38302c36382c35322c36352c3130322c3131302c35352c33372c35302c36362c35312c34372c38382c38352c3130332c3130332c36352c3130382c39392c35352c3131312c36372c38342c3130352c3132322c37392c3130322c39382c39382c3131362c37392c37302c3130382c38392c36352c35322c3130332c35332c37352c39392c38392c3130332c38332c34392c37342c35302c39302c36352c3130312c37372c38312c3131332c39382c38352c3130302c33372c34382c36352c39302c3131352c3130312c39302c36372c39392c39372c39302c39302c39302c3131302c35342c35332c3131362c3130302c3131332c3130312c3130312c35362c38352c38382c39302c3130382c36382c3131382c3132302c34382c33372c35302c36362c37382c3130302c37392c34382c37362c38322c33372c35302c36362c35332c3131322c37302c3132312c33372c35302c36362c3130362c3131372c37372c34382c3131392c38372c39382c3131372c35332c35372c37372c3131382c3132322c39392c3130392c38342c38382c39382c3130362c3131352c3130352c35352c37322c38392c33372c34382c36352c35342c3132322c3130302c35332c35312c38392c3131332c35332c37352c35302c35322c35322c3130322c3131392c37302c37322c38322c38312c35362c3130312c37392c36362c34382c37332c38372c36362c33372c35302c36362c35322c38302c3130322c37372c35352c37302c3130312c36352c36352c3131322c39302c3131382c3130382c3130322c3131332c3130382c37352c37392c3130382c37362c39392c39302c37362c35302c3131372c3132312c38362c3130392c3132322c38322c3130372c3132312c38322c35332c3132312c38372c35352c33372c34382c36352c35302c3131372c3131312c35372c3130392c3130312c3130342c38382c35322c35322c36372c3130352c38302c37342c35302c3130322c3131352c3130312c35372c38392c35342c3130312c38312c3131362c39392c3130322c36392c3130342c37372c38302c3130372c3130392c37322c38382c37332c34382c34392c3131352c37382c33372c35302c36362c37352c3131392c38302c39382c3131322c36352c35312c35372c33372c35302c36362c3132302c37392c3131352c38332c3131362c3130362c3130342c38302c35372c37382c34392c38392c34392c39372c35302c33372c34382c36352c3131362c38312c36352c38362c3131312c33372c35302c36362c3132312c38362c3130332c37362c3130332c38362c35302c37322c3131392c3131352c35352c35312c37302c39392c34382c3131312c35312c3131392c36372c35352c35362c3131332c38302c36392c36352c33372c35302c36362c3131382c35302c39372c38322c3131352c34372c36362c3130312c35312c39302c37302c36382c3130332c36382c3132312c3130332c3130342c39392c34372c34392c3130322c3130332c38352c33372c35302c36362c35352c36372c33372c35302c36362c38302c35342c3130372c39382c3131332c33372c34382c36352c3130302c35322c3131322c3131312c3132312c39382c35342c37332c38372c35362c37352c36372c37342c39382c3132302c3130322c37372c37342c3131382c3130372c3131312c3131342c3130302c37382c37392c3130332c37392c38352c38352c3132302c3131302c3130302c38302c37322c36392c3130352c34372c3131362c39382c34372c38352c35352c3131372c37362c3130362c37362c37392c3130332c38302c36352c33372c35312c36382c33372c35312c36382c33372c34382c36352c34352c34352c34352c34352c34352c36392c37382c36382c33372c35302c34382c36372c36392c38322c38342c37332c37302c37332c36372c36352c38342c36392c34352c34352c34352c34352c34352c33372c34382c36352c34352c34352c34352c34352c34352c36362c36392c37312c37332c37382c33372c35302c34382c36372c36392c38322c38342c37332c37302c37332c36372c36352c38342c36392c34352c34352c34352c34352c34352c33372c34382c36352c37372c37332c37332c37302c38332c3132322c36372c36372c36352c35352c37392c3130332c36352c3131392c37332c36362c36352c3130332c37332c37342c36352c37382c36392c37322c3130302c3130382c34382c3132312c3131312c35352c36372c38352c37372c36352c34382c37312c36372c38332c3131332c37312c38332c37332c39382c35312c36382c38312c36392c36362c36372c3131392c38352c36352c37372c37322c35322c3132302c36372c3132322c36352c37342c36362c3130332c37382c38362c33372c34382c36352c36362c36352c38392c38342c36352c3130382c38362c38342c37372c38312c3131352c3131392c36372c38312c38392c36382c38362c38312c38312c37332c36382c36352c37342c36382c38312c38342c36392c38352c37372c36362c37332c37312c36352c34392c38352c36392c36362c3131392c3131392c37362c38352c35302c37302c3131372c3130302c37312c36392c3130332c38312c35302c3132302c3130342c39392c3130392c36392c3132302c37312c3130362c36352c38392c36362c3130332c37382c38362c33372c34382c36352c36362c36352c3131312c37372c36392c38352c3130382c3131372c3130302c37312c38362c3131352c37332c36392c37382c3131382c39392c3131302c36362c3131382c39392c3130392c37302c34382c39372c38372c35372c3131372c37372c38342c36352c3131392c37362c3130332c38392c36382c38362c38312c38312c36382c36382c36372c3130302c37342c39382c3131302c38322c3130382c39382c36372c36362c38342c38322c34392c3130332c3130332c38312c38382c38322c34382c39302c38382c37382c34382c33372c34382c36352c38392c38382c38322c3131322c39382c35302c35322c3130332c38352c3130392c38362c3131392c39382c35312c37342c34382c37332c37302c37382c3131322c39302c35302c35332c3131322c39382c3130392c39392c3130332c38312c34382c36392c3131392c37332c36362c39392c37382c37372c38342c38392c3132302c37372c38342c36392c34382c37372c38342c38352c3132322c37382c3132322c37372c3132302c38372c3130342c3130332c38302c37372c3130362c36352c34382c37392c38342c36392c3132312c33372c34382c36352c37372c3132322c36392c3132312c37372c3132322c38352c35332c37382c38342c3130382c39372c37372c37322c35322c3132302c36372c3132322c36352c37342c36362c3130332c37382c38362c36362c36352c38392c38342c36352c3130382c38362c38342c37372c38312c3131352c3131392c36372c38312c38392c36382c38362c38312c38312c37332c36382c36352c37342c36382c38312c38342c36392c38352c37372c36362c37332c37312c36352c34392c38352c36392c36362c3131392c3131392c37362c33372c34382c36352c38352c35302c37302c3131372c3130302c37312c36392c3130332c38312c35302c3132302c3130342c39392c3130392c36392c3132302c37312c3130362c36352c38392c36362c3130332c37382c38362c36362c36352c3131312c37372c36392c38352c3130382c3131372c3130302c37312c38362c3131352c37332c36392c37382c3131382c39392c3131302c36362c3131382c39392c3130392c37302c34382c39372c38372c35372c3131372c37372c38342c36352c3131392c37362c3130332c38392c36382c38362c38312c38312c36382c33372c34382c36352c36382c36372c3130302c37342c39382c3131302c38322c3130382c39382c36372c36362c38342c38322c34392c3130332c3130332c38312c38382c38322c34382c39302c38382c37382c34382c38392c38382c38322c3131322c39382c35302c35322c3130332c38352c3130392c38362c3131392c39382c35312c37342c34382c37332c37302c37382c3131322c39302c35302c35332c3131322c39382c3130392c39392c3130332c38312c34382c36392c3131392c3130332c3130332c37312c3130352c37372c36352c34382c37312c33372c34382c36352c36372c38332c3131332c37312c38332c37332c39382c35312c36382c38312c36392c36362c36352c38312c38352c36352c36352c35322c37332c36362c3130362c3131392c36352c3131392c3130332c3130332c37312c37352c36352c3131312c37332c36362c3130332c38312c36372c3130322c38302c37312c38322c33372c35302c36362c3131362c38382c39392c35362c3131372c34392c36392c3131362c37342c3132322c37362c36352c34392c34382c37302c3130312c3131372c34392c38372c3130332c33372c35302c36362c3131322c35352c3130312c33372c34382c36352c37362c3130392c38332c38322c3130392c3130312c39372c36372c37322c39382c3130372c38312c34392c38342c37302c35312c37382c3131392c3130382c35312c38322c3130392c3131322c3131332c38382c3130372c3130312c37312c3132322c37382c37362c3130302c35342c35372c38312c38352c3131302c38372c3131312c3131382c38392c3132312c38362c38332c3131302c3130302c36392c37372c3132312c38392c39392c35312c3131352c37322c3130312c39392c37312c3130332c3130322c3130352c3131302c36392c3130312c3130342c33372c34382c36352c3131342c3130332c36362c37342c38332c36392c3130302c3131352c38332c37342c35372c37302c3131322c39372c37302c3130302c3130312c3131352c3130362c3131352c3132302c3131332c3132322c37312c38322c39372c35302c34382c38302c38392c3130302c3131302c3131302c3130322c38372c39392c36372c38342c3131382c37302c3131312c3131372c3130382c3131322c39382c37302c38322c35322c38362c36362c3131372c38382c3131302c3131302c38362c37362c38362c3132322c3130372c38352c3131382c3130382c38382c38342c33372c34382c36352c37362c34372c38342c36352c3131302c3130302c35362c3131302c37332c39302c3130372c34382c3132322c39302c3130372c37302c37342c35352c38302c35332c37362c3131362c3130312c38302c3131382c3132312c3130372c3130372c39372c3131342c35352c37362c39392c38332c38312c37392c35362c35332c3131392c3131362c39392c38312c3130312c34382c38322c34392c38322c39372c3130322c34372c3131352c38312c35342c3131392c38392c37352c39372c37352c3130392c37302c3130332c36372c37312c3130312c33372c34382c36352c37382c3131322c36392c37342c38352c3130392c3130332c35322c3130372c3131362c39372c3130382c35322c3131332c3130332c37332c36352c3132302c3130372c33372c35302c36362c38312c37322c38352c3132302c38312c36392c35322c35302c3131352c3132302c38362c3130352c37382c35332c3130392c3131332c3130332c3130382c36362c34382c38312c37342c3130302c38352c3131312c3131362c34372c3131312c35372c39372c34372c38362c34372c3130392c37372c3130312c37322c35362c37352c3131382c37392c36352c3130352c38312c33372c34382c36352c39382c3132312c3130352c3131302c3130372c37382c3131302c3130302c3131302c33372c35302c36362c36362c3130332c3130372c35332c3131352c38332c38362c35332c36382c37302c3130332c37302c34382c36382c3130322c3130322c38362c3131332c3130392c38362c37372c39382c3130382c3131362c35332c3131322c35312c3130362c38302c3131362c37332c3130392c3132322c36362c37332c37322c34382c38312c38312c3131342c38382c37342c3131332c35312c35372c36352c38342c35362c39392c38322c3131392c38302c35332c37322c33372c34382c36352c39372c3130322c3131372c38362c3130312c37362c37322c39392c36382c3131352c38322c3131322c35342c3130342c3131312c3130382c35322c38302c33372c35302c36362c39302c37302c37332c3130342c3131372c35362c3130392c3130392c39382c37332c34392c3131372c34382c3130342c37322c35312c38372c34372c34382c36372c35302c36362c3131372c38392c38382c36362c35332c38302c36372c33372c35302c36362c35332c3130352c3132322c37302c37302c3130342c34372c3131302c38302c34382c3130382c39392c35302c37362c3130322c33372c34382c36352c35342c3131342c36392c37362c37392c35372c37362c39302c3130302c3131302c37392c3130342c3131322c37362c34392c36392c3132302c37302c37392c3131332c35372c37322c34372c36362c35362c3131362c38302c38312c35362c35322c38342c35312c38332c3130332c39382c35322c3131302c36352c3130352c3130322c36382c39372c39382c37382c3131362c34372c3132322c3131372c35342c37372c3130392c36372c37312c3131312c35332c38352c35362c3130382c3131392c36392c37302c3131362c37312c37372c33372c34382c36352c38322c3131312c37392c39372c38382c35322c36352c38332c33372c35302c36362c35372c34382c35372c3132302c34382c34382c3130382c38392c3131302c3130392c3131362c3131392c3131352c36382c38362c38372c3131382c35372c3131382c36362c3130352c37342c36372c38382c38322c3131352c36372c36352c3131392c36392c36352c36352c39372c37392c36362c3132312c38342c36372c36362c3132302c3130362c36362c3130332c36362c3130332c37382c38362c37322c38322c35362c36392c38372c38342c36362c38382c33372c34382c36352c37372c37302c38372c3130332c38352c35342c36362c38322c3130342c3130372c35372c3131312c3130302c37322c38322c3131392c37392c3130352c35362c3131382c3130302c37322c37342c34392c39392c35312c38322c3130382c39302c37322c37382c3130382c39392c3131302c39302c3131322c38392c35302c38362c3132322c37362c3130392c3130382c3131372c3130302c37312c38362c3131352c37362c3130392c37382c3131382c39382c38332c35372c3130362c39382c35302c35332c34382c39302c38372c35332c34382c33372c34382c36352c37362c34382c37382c38332c38342c36372c35372c38342c38322c34392c3130332c3131382c38312c38382c38322c34382c39302c38382c37382c34382c38392c38382c38322c3131322c39382c35302c35332c38332c39302c38382c36362c3131382c39392c3131302c38322c38342c39372c38372c3130302c3131372c39372c38372c35332c3131302c38312c34382c36392c3131372c38392c35312c37342c3131352c37372c36362c34382c37312c36352c34392c38352c3130302c36382c3130332c38312c38372c33372c34382c36352c36362c36362c38322c35322c38312c35312c3131362c35302c3131322c3131302c35342c35362c34382c37352c35372c33372c35302c36362c38312c3130362c3130322c3131342c37382c38382c3131392c35352c3130342c3131392c37302c38322c38302c36382c36352c3130322c36362c3130332c37382c38362c37322c38332c37372c36392c37312c36382c36352c38372c3130332c36362c38322c35322c38312c35312c3131362c35302c3131322c3131302c35342c35362c34382c37352c35372c33372c35302c36362c38312c3130362c3130322c3131342c33372c34382c36352c37382c38382c3131392c35352c3130342c3131392c37302c38322c38302c36382c36352c37392c36362c3130332c37382c38362c37322c38312c35362c36362c36352c3130322c35362c36392c36362c36352c37372c36372c36352c38312c38392c3131392c36392c3130332c38392c36382c38362c38322c34382c38342c36352c38312c37322c34372c36362c36352c3130332c3131392c36362c3130332c36392c36362c34372c3131392c37332c36362c36352c36382c36352c37382c36362c3130332c3130372c3131332c33372c34382c36352c3130342c3130372c3130352c37312c35372c3131392c34382c36362c36352c38312c3131352c37302c36352c36352c37392c36372c36352c38392c36392c36352c3130312c37302c35362c3131362c38392c37372c38382c37332c36372c3131382c38312c3131332c3130312c38382c38392c38312c37332c38342c3130372c38362c35302c3131312c37362c37342c3131352c3131322c35342c37342c35322c37342c36352c3131332c37342c39372c39382c37322c38372c3132302c38392c37342c37322c37312c3130352c3131342c33372c34382c36352c37332c36392c3131332c3131372c39392c38322c3130352c37342c38332c38332c3132302c33372c35302c36362c37322c3130362c37332c37342c36392c38352c38362c39372c3130362c35362c36392c34382c38312c3130362c36392c3131372c3130302c35342c38392c35332c3130382c37382c3130392c38382c3130382c39392c3130362c3131332c38322c38382c39372c36372c38302c37392c3131332c37352c34382c3130312c37312c38322c3132322c35342c3130342c3130352c33372c35302c36362c3131342c3130352c3131322c37372c3131362c38302c39302c33372c34382c36352c3131352c37302c37382c39372c36362c3131392c37362c38312c38362c38362c35372c34382c35332c38332c36382c3130362c36352c3132322c36382c3132322c37382c37332c36382c3131302c3131342c39392c3131302c38382c3132312c36362c35322c3130332c39392c36382c37302c36372c3131382c3131392c36382c37302c37352c37352c3130332c37362c38322c3130362c37392c36362c34372c38372c36352c3131332c3130332c3131352c39392c36382c38352c3131312c37312c3131332c35332c39302c38362c3130352c33372c34382c36352c3132322c37362c38352c3132322c38342c3131332c3130352c38312c38302c3130392c38352c37362c36352c38312c39372c36362c35372c39392c35342c37392c3131362c3130352c35342c3131352c3131302c36392c37302c37342c3130352c36372c38312c35342c35352c37342c37362c3132312c38372c34372c36392c35362c35312c34372c3130322c3131342c3132322c36372c3130392c37392c35332c38322c3131372c35342c38372c3130362c38352c35322c3131362c3130392c3131352c3130392c3132312c35362c38322c39372c33372c34382c36352c38352c3130302c35322c36352c38302c37352c34382c3131392c39302c38342c37312c3131362c3130322c38302c38382c38352c35352c3131392c33372c35302c36362c37332c36362c3130302c37312c35332c36392c3132322c34382c3130372c36392c34392c3131332c3132322c3132302c37312c38312c39372c37362c35322c3130332c37332c37382c37342c34392c3132322c37372c3132312c3130382c3130312c36382c3131302c39382c3131372c38332c35362c38352c3130352c39392c3130362c37342c3130352c3130362c3131382c3131332c36352c33372c34382c36352c34392c35332c35302c38332c3131332c34382c35322c35372c36392c38332c36382c3132322c33372c35302c36362c34392c3131342c38322c37312c39392c35302c37382c38362c36392c3131332c3130342c34392c37352c39372c37312c38382c3130392c3131362c38382c3131382c3131332c3132302c38382c39392c38342c36362c33372c35302c36362c37362c3130362c3132312c35332c36362c3131392c35302c3130372c3130312c34382c3131382c35362c3130352c37312c3131302c3130332c37302c36362c38302c3131332c36372c38342c38362c36362c33372c34382c36352c35312c3131312c3131322c35332c37352c36362c37312c35312c38322c3130362c39382c37302c35342c38322c38322c38332c3132322c3131392c3132322c3131372c38372c3130322c37362c35352c38312c36392c3131342c37382c36372c35362c38372c36392c3132312c35332c3132312c36382c38362c36352c38322c3132322c38342c36352c35332c33372c35302c36362c3132302c3130392c36362c39392c35312c35362c35362c3131382c35372c36382c3130392c35302c34392c37322c37312c3130322c39392c36372c35362c37392c33372c34382c36352c36382c36382c33372c35302c36362c3130332c38342c35372c3131352c38332c3131322c3131352c3131352c3131332c34382c39372c3131352c39392c3130392c3131382c37322c35322c35372c37372c37392c3130332c3130362c3131362c34392c3132312c3131312c3132312c3131352c37362c3131362c3130302c36372c3131362c37342c38372c34372c35372c37302c39302c3131322c3131312c37392c3132312c3131322c39372c37322c3132302c34382c38322c33372c35302c36362c3130392c37342c38342c37362c3131392c38302c38382c38362c37372c3131342c3131382c33372c34382c36352c36382c39372c38362c3132322c38372c3130342c35332c39372c3130352c36392c3132302c33372c35302c36362c3130352c3130302c3130372c38332c37312c37372c3131302c38382c33372c34382c36352c34352c34352c34352c34352c34352c36392c37382c36382c33372c35302c34382c36372c36392c38322c38342c37332c37302c37332c36372c36352c38342c36392c34352c34352c34352c34352c34352c33372c34382c36355d7d300a06082a8648ce3d0403020349003046022100cd0e9db8424c3810ad334ddbebcb61ce46a29501bbb8942abd4df63f3da09f6b02210099d459377183f5be66e81c2956c79f4a4a11039cf0223a278320f16db653abab002100010002010000020003020002000300100000000000000000000000005f439ad4004830460221008cbb226236c79b521490472d270745f46271217f1ecf188d3a8387026238b90c022100854ee755754a08d68739a7743cd671886baf9c8bc6bad26bc925d3425a6c813f"
            const blob = Buffer.from(blobStr, "hex")

            const addrResponse = await app.getAddressAndPubKey(path);
            console.log(addrResponse)

            const pk = Uint8Array.from(addrResponse.publicKey)
            const blobToHash = blob.slice(2, blob.length)
            const msgHash = Uint8Array.from(blake3
                .newRegular()
                .update(blobToHash)
                .finalize(32, "bytes"));
            console.log("Blob To Hash: ", Buffer.from(blobToHash).toString("hex"))
            console.log("TX ID       :  ", Buffer.from(msgHash).toString("hex"))

            // Do not await.. we need to click asynchronously
            const signatureRequest = app.sign(path, blob);
            // Wait until we are not in the main menu
            await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot(), 20000);

            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickRight();
            await sim.clickBoth();

            let signatureResponse = await signatureRequest;
            console.log(signatureResponse)
            expect(signatureResponse.returnCode).toEqual(0x9000);

            // Now verify the signature
            const signature = secp256k1.signatureImport(Uint8Array.from(signatureResponse.signatureDER));
            const signatureOk = secp256k1.ecdsaVerify(signature, msgHash, pk);
            expect(signatureOk).toEqual(true);
        } finally {
            await sim.close();
        }
    });

});
